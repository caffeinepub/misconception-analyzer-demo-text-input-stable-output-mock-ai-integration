{
  "kind": "build_request",
  "title": "Fix Gemini API key integration and perform analysis via backend canister",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Implement a public backend canister method `analyzeExplanation(explanation : Text) : async ExplanationAnalysis` in `backend/main.mo` that produces a non-placeholder `{ misconception; whyFailed }` result derived from the caller-provided explanation text.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "use this API Key-\"AIzaSyCcSIgdCctZbO4NGcGY81XoWsfrL1EaEqw\""
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` exports a public `analyzeExplanation` method.",
        "The returned record has exactly two text fields: `misconception` and `whyFailed` (both non-empty for non-empty input).",
        "For the same input explanation, the result is derived from that input (not fixed placeholder strings)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Use the provided Gemini API key exactly as given (`AIzaSyCcSIgdCctZbO4NGcGY81XoWsfrL1EaEqw`) for the backend’s Gemini call, and ensure the frontend never calls Gemini directly and never embeds/exposes the API key in browser-delivered code.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-2",
          "msg-3"
        ],
        "quotes": [
          "make it quick",
          "use this API Key-\"AIzaSyCcSIgdCctZbO4NGcGY81XoWsfrL1EaEqw\""
        ]
      },
      "acceptanceCriteria": [
        "No frontend code path performs a direct Gemini request from the browser.",
        "The Gemini API key string does not appear in any frontend source/bundle output.",
        "When analysis succeeds via backend, the UI shows the backend result (no fallback disclosure prefix is added).",
        "If backend analysis fails, the existing fallback behavior in `frontend/src/hooks/useQueries.ts` continues to work and clearly discloses fallback usage."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Update the backend so that when it calls Gemini it uses the existing analysis intent reflected by the app’s prompt (misconception detection + why the mental model failed), and map the model response into `ExplanationAnalysis` (`misconception`, `whyFailed`).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "use this API Key-\"AIzaSyCcSIgdCctZbO4NGcGY81XoWsfrL1EaEqw\""
        ]
      },
      "acceptanceCriteria": [
        "Backend Gemini responses are transformed into `misconception` and `whyFailed` fields suitable for rendering in the existing UI.",
        "If the Gemini response is missing/invalid, the backend returns a controlled error so the frontend can fall back (rather than returning an invalid shape)."
      ]
    }
  ],
  "constraints": [
    "Use English for any user-facing text.",
    "Do not edit any files under `frontend/src/components/ui` (read-only UI component sources must be composed, not edited).",
    "Do not edit files listed as immutable: `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useInternetIdentity.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`.",
    "Preserve the API key exactly as provided: `AIzaSyCcSIgdCctZbO4NGcGY81XoWsfrL1EaEqw`.",
    "Do not place the API key in frontend environment variables or any browser-delivered code."
  ],
  "nonGoals": [
    "Adding third-party authentication providers beyond Internet Identity.",
    "Adding real-time features (WebSockets/push notifications/chat).",
    "Introducing external databases or non-Motoko backend services."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}